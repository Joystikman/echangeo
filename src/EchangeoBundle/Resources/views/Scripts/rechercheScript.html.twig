<!-- /* =======================================================
 * Ensembles des fonction utile à la recherche de services
 * par Guiraud Maxime
 * =======================================================*/ -->
<!-- Recherche -->
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAP6ZUJ4H43dX3bjj-uNmFwal8Yi0iZX9g"></script>
<script type="text/javascript">
	/*scripts de recherche*/
	function displaySousCategorie(event) {
		/*récupération de la catégorie choisie*/
		var id = this.options[this.selectedIndex].value;
		/*création de l'url*/ 
		var url = "{{ path('getSousCategories',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
		url = url.replace("idPlaceholder", id);
		/*on vide les div et on enleve les anciens marqueurs de la carte*/
		$("#titre").empty();	
		$("#liste").empty();	
		$("#liste").append($("<img class='loading' src={{ asset('assets/Loading_icon.gif')}}>"));	
		clearMarkers();
		/*fonction ajax - recuperation des services dans les categorie choisies*/
		$.ajax({
			url: url,
			type: "GET",
			dataType: "json",
			success: function(data){
				$("#liste").empty();
				$('#select2').empty();
				$('#select2').append($("<form id='formSousCategorie' method='get'>"));
				for(var i=0; i<data.length; i++){
					/*affichage de la selection des sousCategorie*/ 
					$('#formSousCategorie').append($("<h4>").text(data[i].libelle));
					$('#formSousCategorie').append($("<input type='checkbox' value="+data[i].id+"  onchange='displayServices()'>"));
					/*affichage des annonces de la categorie*/
					for(var j=0; j<data[i].services.length; j++){
						$('#titre').text("Annonces disponibles :")
						$('#liste').append($("<div>")
							.append($("<h3>").text(data[i].services[j].titre))
							.append($("<p>").text("Proposé par : "+data[i].services[j].inscrit.username))
							.append($("<a id="+data[i].services[j].id+" href='#' class='button_details'>").text('voir en détails'))
						);
						markerServices(false,data[i].services[j],data[i].icone);
						$('#'+data[i].services[j].id).on("click", function(){
				        	var selectedId = $(this).attr("id");
				        	console.log("Service n°: "+selectedId);  
				        	/*création de l'url*/ 
									var url = "{{ path('getserviceID',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
									url = url.replace("idPlaceholder", selectedId);
									var urlForm = "{{ path('reponse_service') }}";
									console.log("url :");
									console.log(url);
									/*AJAX*/
									$("#titre").empty();	
									$("#liste").empty();	
									$("#liste").append($("<img class='loading' src={{ asset('assets/Loading_icon.gif')}}>"));	
									$.ajax({
										url: url,
										type: "GET",
										dataType: "json",
										success: function(data){
											console.log('click -> voir details');
											console.log(data);
											$("#liste").empty();
											/*$('#titre').text("<- retour");*/
											$('#liste').append($("<div id='serviceDetail'>"));
											$('#serviceDetail').append($("<h3>").text(data.titre));
											$('#serviceDetail').append($("<p>").text("Proposé par : "+data.inscrit.username));
											$('#serviceDetail').append($("<p>").text(""+data.description));
											{% if app.user %}
											$('#serviceDetail').append($("<form id='formulaire' action="+urlForm+" method='POST'>"));
												$('#serviceDetail').append($("<input type='hidden' name='idService' value="+data.id+">"));
												$('#serviceDetail').append($("<input type='text' name='dateRDV' placeholder='aaaa/mm/jj h:m'>"));
												$('#serviceDetail').append($("<input type='text' name='message' placeholder='message'>"));
												$('#serviceDetail').append($("<input type='submit' name='envoie' value='répondre'>"));
											{% else %}
												$('#serviceDetail').append($("<p>").append($("<a href='{{ path('fos_user_security_login') }}''>connecter vous répondre à cette annonce</a>")));
											{% endif %}
										},
										error: function (req, status, err){
											console.log("erreur");
											console.log(err);
										}
									});
									return false;        
				    	});
					}
				}
			},
			error: function (req, status, err){
				console.log("erreur");
				console.log(err);
			}
		});
		return false;
	}

	function displayServices(){
		console.log("activation displayServices");
		var selectedId = [];
		$('#formSousCategorie input:checked').each(function() {
    		selectedId.push($(this).attr('value'));
		});
		console.log('liste des sousCatégorie choisie(s) :');
		console.log(selectedId);
		/*création de l'url*/ 
		var url = "{{ path('getServicesSousCategories',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
		url = url.replace("idPlaceholder", selectedId);
		console.log("url :");
		console.log(url);
		/*AJAX*/
		/*$("#titre").empty();*/	
		$("#liste").empty();
		$("#liste").append($("<img class='loading' src={{ asset('assets/Loading_icon.gif')}}>"));	
		clearMarkers();
		$.ajax({
			url: url,
			type: "GET",
			dataType: "json",
			success: function(data){
				console.log('test rqt Ajax');
				console.log(data);
				$("#liste").empty();
				for(var i=0; i<data.length; i++){
					$('#liste').append($("<div>")
						.append($("<h3>").text(data[i][0].titre))
						.append($("<p>").text("Proposé par : "+data[i][0].inscrit.username))
						.append($("<a id="+data[i][0].id+" href='#' class='button_details'>").text('voir en détails'))
					);
					markerServices(false,data[i][0],data[i][0].sous_categorie.icone);
					$('#'+data[i][0].id).on("click", function(){
				        	var selectedId = $(this).attr("id");
				        	console.log("Service n°: "+selectedId);  
				        	/*création de l'url*/ 
							var url = "{{ path('getserviceID',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
							url = url.replace("idPlaceholder", selectedId);
							var urlForm = "{{ path('reponse_service') }}";
							console.log("url :");
							console.log(url);
							/*AJAX*/
							$("#titre").empty();	
							$("#liste").empty();	
							$("#liste").append($("<img class='loading' src={{ asset('assets/Loading_icon.gif')}}>"));
							$.ajax({
								url: url,
								type: "GET",
								dataType: "json",
								success: function(data){
									console.log('test rqt Ajax');
									console.log(data);
									$("#liste").empty();
									$('#titre').text("<- retour");
									/*$('#titre').on("click", function(){
										displayServices();
									});*/
									$('#liste').append($("<div id='serviceDetail'>"));
									$('#serviceDetail').append($("<h3>").text(data.titre));
									$('#serviceDetail').append($("<p>").text("Proposé par : "+data.inscrit.username));
									$('#serviceDetail').append($("<p>").text(""+data.description));
									{% if app.user %}
									$('#serviceDetail').append($("<form id='formulaire' action="+urlForm+" method='POST'>"));
										$('#serviceDetail').append($("<input type='hidden' name='idService' value="+data.id+">"));
										$('#serviceDetail').append($("<input type='text' name='dateRDV' placeholder='aaaa/mm/jj h:m'>"));
										$('#serviceDetail').append($("<input type='text' name='message' placeholder='message'>"));
										$('#serviceDetail').append($("<input type='submit' name='envoie' value='répondre'>"));
									{% else %}
										$('#serviceDetail').append($("<p>").append($("<a href='{{ path('fos_user_security_login') }}''>connecter vous répondre à cette annonce</a>")));
									{% endif %}
								},
								error: function (req, status, err){
									console.log("erreur click service");
									console.log(err);
								}
							});        
				    	});
				}
			},
			error: function (req, status, err){
				console.log("erreur display service ¯|_(ツ)_/¯");
				console.log(err);
			}
		});
	}

	//Details des services
	$(document).ready(function(){
    	$('#liste a').on("click", function(){
				        	var selectedId = $(this).attr("id");
				        	console.log("Service n°: "+selectedId);  
				        	/*création de l'url*/ 
							var url = "{{ path('getserviceID',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
							url = url.replace("idPlaceholder", selectedId);
							var urlForm = "{{ path('reponse_service') }}";
							console.log("url :");
							console.log(url);
							/*AJAX*/
							$("#titre").empty();	
							$("#liste").empty();	
							$("#liste").append($("<img class='loading' src={{ asset('assets/Loading_icon.gif')}}>"));	
							$.ajax({
								url: url,
								type: "GET",
								dataType: "json",
								success: function(data){
									console.log('liste a -> voir details');
									console.log(data);
									$("#liste").empty();
									/*$('#titre').text("<- retour");*/
									$('#liste').append($("<div id='serviceDetail'>"));
									$('#serviceDetail').append($("<h3>").text(data.titre));
									$('#serviceDetail').append($("<p>").text("Proposé par : "+data.inscrit.username));
									$('#serviceDetail').append($("<p>").text(""+data.description));
									{% if app.user %}
										$('#serviceDetail').append($("<form id='formulaire' action="+urlForm+" method='POST'>"));
										$('#serviceDetail').append($("<input type='hidden' name='idService' value="+data.id+">"));
										$('#serviceDetail').append($("<input type='text' name='dateRDV' placeholder='aaaa/mm/jj h:m'>"));
										$('#serviceDetail').append($("<input type='text' name='message' placeholder='message'>"));
										$('#serviceDetail').append($("<input type='submit' name='envoie' value='répondre'>"));
									{% else %}
										$('#serviceDetail').append($("<p>").append($("<a href='{{ path('fos_user_security_login') }}''>connecter vous répondre à cette annonce</a>")));
									{% endif %}
								},
								error: function (req, status, err){
									console.log("erreur");
									console.log(err);
								}
							});        
				    	});
	});

/*CARTE*/

	var key = "key=AIzaSyAP6ZUJ4H43dX3bjj-uNmFwal8Yi0iZX9g";
	var position = [48.858727, 2.344376];
	var map = null;
	var markers = [];
	   
	function showGoogleMapsDefaut() {
		console.log("display map");
		console.log($('#body').width());
		if($('#body').width()<700) {
			console.log('mobile');
			$('#googlemaps').height(300);
		}
		else{
	    	$('#googlemaps').height($('#main').height());
		}
	     	     
	    /*paramètres de la map*/
	    var latLng = new google.maps.LatLng(position[0], position[1]);
	    var mapOptions = {
	      zoom: 13, // initialize zoom level - the max value is 21
	      streetViewControl: false, // hide the yellow Street View pegman
	      scaleControl: true, // allow users to zoom the Google Map
	      mapTypeId: google.maps.MapTypeId.ROADMAP,
	      center: latLng
	    };
	    //Affichage de la map
	    map = new google.maps.Map(document.getElementById('googlemaps'),mapOptions);
	    
	    //Affichage des marqueurs de services 
	    markerServices(true,null,null);
	  }

	function markerServices(defaut,service,icone){
		if(defaut){
			{% for service in services %}
				var position = "{{service.lieu}}".split(",");
				var latLng = new google.maps.LatLng(position[0], position[1]);
				console.log("service pos : "+position);
				var nom_icone = "{{service.sousCategorie.icone}}";
				var uri_icone = "{{ asset('assets/icones/placeholder')}}";
				uri_icone = uri_icone.replace("placeholder", nom_icone);
				//var uri_icone = "{{ asset('assets/icones/"+nom_icone+"')}}";
				console.log(uri_icone);
				var marker = new google.maps.Marker({
			            position: latLng,
			            map: map,
			            icon:uri_icone,
			            draggable: false,
			            animation: google.maps.Animation.DROP
			    });
			    markers.push(marker);
			{% endfor %}
		}
		else{
			var position = service.lieu.split(",");
			var latLng = new google.maps.LatLng(position[0], position[1]);
			var uri_icone = "{{ asset('assets/icones/placeholder')}}";
			uri_icone = uri_icone.replace("placeholder", icone);
			var marker = new google.maps.Marker({
			        position: latLng,
			        map: map,
			        icon : uri_icone,
			        draggable: false,
			        animation: google.maps.Animation.DROP
			});
			markers.push(marker);
		}	
	}

	function clearMarkers(){
		for (var i = 0; i < markers.length; i++) {
    		markers[i].setMap(null);
  		}
	}

	google.maps.event.addDomListener(window, 'load', showGoogleMapsDefaut);
</script>

