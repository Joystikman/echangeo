<!-- /* =======================================================
 * Ensembles des fonction utile à la recherche de services
 * par Guiraud Maxime
 * =======================================================*/ -->
<!-- Recherche -->
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAP6ZUJ4H43dX3bjj-uNmFwal8Yi0iZX9g"></script>
<script type="text/javascript">
	var chargement = "<img class='loading' src={{ asset('assets/Loading_icon.gif')}}>";
	/*scripts de recherche*/
	function displaySousCategorie(event) {
		/*récupération de la catégorie choisie*/
		var id = this.options[this.selectedIndex].value;
		/*création de l'url*/ 
		var url = "{{ path('getSousCategories',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
		url = url.replace("idPlaceholder", id);
		/*on vide les div et on enleve les anciens marqueurs de la carte*/
		$("#titre").empty();	
		$("#liste").empty();	
		$("#liste").append($(chargement));	
		clearMarkers();
		/*fonction ajax - recuperation des services dans les categorie choisies*/
		$.ajax({
			url: url,
			type: "GET",
			dataType: "json",
			success: function(data){
				console.log(data);
				$("#liste").empty();
				$('#select2').empty();
				$('#select2').append($("<form id='formSousCategorie' class='sousCategorie' method='get'>"));
				$('#formSousCategorie').append($("<ul id='listeCategories'>"));
				/*affichage de la selection des sousCategorie*/ 
				for(var i=0; i<data.length-1; i++){
					$('#listeCategories').append($("<li id=categorie"+data[i].id+">"));
					$('#categorie'+data[i].id).append($("<label class='labelSC'>").text(data[i].libelle));
					$('#categorie'+data[i].id).append($("<input type='checkbox' value="+data[i].id+"  onchange='displayServices()'>"));
				}
				/*affichage des annonces de la categorie*/
				for(var i=0; i<data[data.length-1].length; i++){
					var service = data[data.length-1][i];
					$('#titre').text("Annonces disponibles :");
					$('#liste').append($("<div class='tuile'>")
						.append($("<h3>").text(service.titre))
						.append($("<p>").text("Proposé par : "+service.username))
						.append($("<p>").text("Du : "+moment(service.debut).lang('fr').format("LLL")+" au "+moment(service.fin).lang('fr').format("LLL")))
						.append($("<a id="+service.id+" href='#' class='btn btn-primary'>").text('voir en détails'))
					);
					/*affichage des annonce à la carte*/
					markerServices(false,service,service.icone);
					$('#'+service.id).on("click", function(){
				       	var selectedId = $(this).attr("id");
				       	console.log("Service n°: "+selectedId);  
				       	/*création de l'url*/ 
								var url = "{{ path('getserviceID',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
								url = url.replace("idPlaceholder", selectedId);
								var urlForm = "{{ path('reponse_service') }}";
								console.log("url :");
								console.log(url);
								/*AJAX*/
								$("#titre").empty();	
								$("#liste").empty();	
								$("#liste").append($(chargement));	
								$.ajax({
									url: url,
									type: "GET",
									dataType: "json",
									success: function(data){
										console.log('click -> voir details');
										console.log(data);
										$("#liste").empty();
										/*$('#titre').text("<- retour");*/
										$('#liste').append($("<div id='serviceDetail' class='serviceDetail'>"));
										$('#serviceDetail').append($("<h3>").text(data.titre));
										$('#serviceDetail').append($("<p>").text("Proposé par : "+data.username));
										$('#serviceDetail').append($("<p>").text("Du : "+moment(data.debut).lang('fr').format("LLL")+" au "+moment(data.fin).lang('fr').format("LLL") ));
										$('#serviceDetail').append($("<p>").text(""+data.description));
										{% if app.user %}
											$('#serviceDetail').append($("<form id='formulaire' action="+urlForm+" method='POST'>"));
											$('#serviceDetail').append($("<input type='hidden' name='idService' value="+data.id+">"));
											$('#serviceDetail').append($("<input id='date' class='form-control' type='text' name='dateRDV' placeholder='aaaa/mm/jj h:m'>"));
											/*$("#date").datepicker();*/
											var picker = new Pikaday({ field: $('#date')[0] });
											$('#serviceDetail').append($("<textarea type='text' class='form-control' name='message' placeholder='message'>"));
											$('#serviceDetail').append($("<input type='submit' class='btn btn-success' name='envoie' value='répondre'>"));
										{% else %}
											$('#serviceDetail').append($("<p>").append($("<a class='btn btn-success' href='{{ path('fos_user_security_login') }}''>connecter vous répondre à cette annonce</a>")));
										{% endif %}
									},
									error: function (req, status, err){
										console.log("erreur");
										console.log(err);
									}
								});
								return false;        
				   	});
					}
			},
			error: function (req, status, err){
				console.log("erreur");
				console.log(err);
			}
		});
		return false;
	}

	function displayServices(){
		console.log("activation displayServices");
		var selectedId = [];
		$('#formSousCategorie input:checked').each(function() {
    		selectedId.push($(this).attr('value'));
		});
		console.log('liste des sousCatégorie choisie(s) :');
		console.log(selectedId);
		/*création de l'url*/ 
		var url = "{{ path('getServicesSousCategories',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
		url = url.replace("idPlaceholder", selectedId);
		console.log("url :");
		console.log(url);
		/*AJAX*/
		/*$("#titre").empty();*/	
		$("#liste").empty();
		$("#liste").append($(chargement));	
		clearMarkers();
		$.ajax({
			url: url,
			type: "GET",
			dataType: "json",
			success: function(data){
				console.log('test rqt Ajax');
				console.log(data);
				$("#liste").empty();
				for(var i=0; i<data.length; i++){
					$('#liste').append($("<div class='tuile'>")
						.append($("<h3>").text(data[i].titre))
						.append($("<p>").text("Proposé par : "+data[i].username))
						.append($("<p>").text("Du : "+moment(data[i].debut).lang('fr').format("LLL")+" au "+moment(data.fin).lang('fr').format("LLL")))
						.append($("<a id="+data[i].id+" href='#' class='btn btn-primary'>").text('voir en détails'))
					);
					markerServices(false,data[i],data[i].icone);
					$('#'+data[i].id).on("click", function(){
				        	var selectedId = $(this).attr("id");
				        	console.log("Service n°: "+selectedId);  
				        	/*création de l'url*/ 
							var url = "{{ path('getserviceID',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
							url = url.replace("idPlaceholder", selectedId);
							var urlForm = "{{ path('reponse_service') }}";
							console.log("url :");
							console.log(url);
							/*AJAX*/
							$("#titre").empty();	
							$("#liste").empty();	
							$("#liste").append($(chargement));
							$.ajax({
								url: url,
								type: "GET",
								dataType: "json",
								success: function(data){
									console.log('test rqt Ajax');
									console.log(data);
									$("#liste").empty();
									/*$('#titre').text("<- retour");*/
									/*$('#titre').on("click", function(){
										displayServices();
									});*/
									$('#liste').append($("<div id='serviceDetail' class='serviceDetail'>"));
									$('#serviceDetail').append($("<h3>").text(data.titre));
									$('#serviceDetail').append($("<p>").text("Proposé par : "+data.username));
									$('#serviceDetail').append($("<p>").text("Du : "+moment(data.debut).lang('fr').format("LLL")+" au "+moment(data.fin).lang('fr').format("LLL")));
									$('#serviceDetail').append($("<p>").text(""+data.description));
									{% if app.user %}
										$('#serviceDetail').append($("<form id='formulaire' action="+urlForm+" method='POST'>"));
										$('#formulaire').append($("<input type='hidden' name='idService' value="+data.id+">"));
										$('#formulaire').append($("<input id='date' type='text' class='form-control' name='dateRDV' placeholder='aaaa/mm/jj h:m'>"));
										/*$("#date").datepicker();*/
										var picker = new Pikaday({ field: $('#date')[0] });
										$('#formulaire').append($("<textarea type='text' class='form-control' name='message' placeholder='message'>"));
										$('#formulaire').append($("<input type='submit' class='btn btn-success' name='envoie' value='répondre'>"));
									{% else %}
										$('#serviceDetail').append($("<p>").append($("<a href='{{ path('fos_user_security_login') }}''>connecter vous répondre à cette annonce</a>")));
									{% endif %}
								},
								error: function (req, status, err){
									console.log("erreur click service");
									console.log(err);
								}
							});        
				    	});
				}
			},
			error: function (req, status, err){
				console.log("erreur display service ¯|_(ツ)_/¯");
				console.log(err);
			}
		});
	}

	//Details des services
	$(document).ready(function(){
    	$('#liste a').on("click", function(){
    						/*Affichage du chargement*/
    						$("#titre").empty();	
							$("#liste").empty();	
							$("#liste").append($(chargement));
				        	var selectedId = $(this).attr("id");
				        	console.log("Service n°: "+selectedId);  
				        	/*création de l'url*/ 
							var url = "{{ path('getserviceID',{ 'id': "idPlaceholder" , '_format': 'json'}) }}";
							url = url.replace("idPlaceholder", selectedId);
							var urlForm = "{{ path('reponse_service') }}";
							console.log("url :");
							console.log(url);
							/*AJAX*/								
							$.ajax({
								url: url,
								type: "GET",
								dataType: "json",
								success: function(data){
									console.log('liste a -> voir details');
									console.log(data);
									$("#liste").empty();
									$('#liste').append($("<div id='serviceDetail' class='serviceDetail'>"));
									$('#serviceDetail').append($("<h3>").text(data.titre));
									$('#serviceDetail').append($("<p>").text("Proposé par : "+data.username));
									$('#serviceDetail').append($("<p>").text("Du : "+moment(data.debut).lang('fr').format("LLL")+" au "+moment(data.fin).lang('fr').format("LLL")));
									$('#serviceDetail').append($("<p>").text(""+data.description));
									{% if app.user %}
										$('#serviceDetail').append($("<form id='formulaire' action="+urlForm+" method='POST'>"));
										$('#formulaire').append($("<input type='hidden' name='idService' value="+data.id+">"));
										$('#formulaire').append($("<input id='date' type='text' class='form-control' name='dateRDV' placeholder='aaaa/mm/jj h:m'>"));
										/*$("#date").datepicker();*/
										var picker = new Pikaday({ field: $('#date')[0] });
										$('#formulaire').append($("<textarea type='text' class='form-control' name='message' placeholder='message'>"));
										$('#formulaire').append($("<input type='submit' class='btn btn-success' name='envoie' value='répondre'>"));
									{% else %}
										$('#serviceDetail').append($("<p>").append($("<a class='btn btn-success' href='{{ path('fos_user_security_login') }}''>connecter vous répondre à cette annonce</a>")));
									{% endif %}
								},
								error: function (req, status, err){
									console.log("erreur");
									console.log(err);
								}
							});        
				    	});
	});

/*CARTE*/

	var key = "key=AIzaSyAP6ZUJ4H43dX3bjj-uNmFwal8Yi0iZX9g";
	var position = [48.858727, 2.344376];
	var map = null;
	var markers = [];
	   
	function showGoogleMapsDefaut() {
		console.log("display map");
		console.log($('#body').width());
		if($('#body').width()<700) {
			console.log('mobile');
			$('#googlemaps').height(300);
		}
		else{
	    	$('#googlemaps').height($('#services').height());
		}
	     	     
	    /*paramètres de la map*/
	    var latLng = new google.maps.LatLng(position[0], position[1]);
	    var mapOptions = {
	      zoom: 13, // initialize zoom level - the max value is 21
	      streetViewControl: false, // hide the yellow Street View pegman
	      scaleControl: true, // allow users to zoom the Google Map
	      mapTypeId: google.maps.MapTypeId.ROADMAP,
	      center: latLng
	    };

	    //Affichage de la map
	    map = new google.maps.Map(document.getElementById('googlemaps'),mapOptions);
	    
	    //Affichage des marqueurs de services 
	    markerServices(true,null,null);
	  }

	function markerServices(defaut,service,icone){
		if(defaut){
			{% for service in services %}
				var position = "{{service.lieu}}".split(",");
				var latLng = new google.maps.LatLng(position[0], position[1]);
				console.log("service pos : "+position);
				var nom_icone = "{{service.sousCategorie.icone}}";
				var uri_icone = "{{ asset('assets/icones/placeholder')}}";
				uri_icone = uri_icone.replace("placeholder", nom_icone);
				console.log(uri_icone);
				var marker = new google.maps.Marker({
			            position: latLng,
			            map: map,
			            icon:uri_icone,
			            draggable: false,
			            animation: google.maps.Animation.DROP
			    });
			    markers.push(marker);
			{% endfor %}
		}
		else{
			var position = service.lieu.split(",");
			var latLng = new google.maps.LatLng(position[0], position[1]);
			var uri_icone = "{{ asset('assets/icones/placeholder')}}";
			uri_icone = uri_icone.replace("placeholder", icone);
			var marker = new google.maps.Marker({
			        position: latLng,
			        map: map,
			        icon : uri_icone,
			        draggable: false,
			        animation: google.maps.Animation.DROP
			});
			markers.push(marker);
		}	
	}

	function clearMarkers(){
		for (var i = 0; i < markers.length; i++) {
    		markers[i].setMap(null);
  		}
	}

	google.maps.event.addDomListener(window, 'load', showGoogleMapsDefaut);
</script>

